# 项目修改日志

**日期:** 2024-07-27

## 本次会话主要修改内容

本次会话主要围绕下位机与上位机的 UART3 通讯协议进行了调整和验证，并解决了相关的编译和任务运行问题。

### 1. UART3 通信协议调整 (接收命令帧 - 功能码 0x31)

- **初始目标:** 简化上位机发送的命令帧，移除不再需要的夹爪电机（Gripper Motors: GM6020, C610, STS3032）控制数据。
- **中间步骤:**
    - 修改 `HARDWARE/uart3.c` 中的 `USART3_IRQHandler` 函数，尝试注释掉解析夹爪数据的代码块。
    - 对应修改 `expected_length` 为 `0x3F`（63字节 Payload），更新 `header_sequence` 数组以反映新的长度和项目计数（`0x0D`）。
    - 更新 `与上位机通讯问题.md` 文档以匹配简化的 69 字节命令帧。
- **问题发现:** 直接移除（或注释掉）`uart3.c` 中的夹爪全局变量定义（如 `gripper_gm6020_position_control`）会导致链接错误，因为 `TASK/gimbal_task.c` 和 `TASK/start_task.c` 仍然引用这些变量。
- **临时方案:** 恢复 `uart3.c` 中夹爪全局变量的定义，但保持解析这些变量的代码块处于注释状态。
- **最终决定 (应用户要求):** 为了避免修改上位机代码，**恢复 `USART3_IRQHandler` 对原始 81 字节命令帧的完整解析能力**。
    - 恢复 `header_sequence` 数组定义为 `{0xAA, 0x55, 0x01, 0x4B, 0x31, 0x10}`。
    - 恢复 `expected_length` 的赋值为 `0x4B`。
    - 恢复（取消注释）`USART3_IRQHandler` 中解析夹爪电机数据的代码块。
- **当前状态:** 下位机现在可以接收并解析包含夹爪数据的 81 字节命令帧，与原始协议兼容。

### 2. 任务激活问题 (`Chasis_task`)

- **问题:** 在调试时发现 `Chasis_task` 没有运行，无法在该任务中断点。
- **原因:** 定位到 `TASK/task.h` 文件中 `#define EN_CHASIS_TASK 0u`，导致该任务未被编译和启动。
- **修复:** 将 `TASK/task.h` 中的 `#define EN_CHASIS_TASK` 的值修改为 `1u`，成功启用了 `Chasis_task`。

### 3. 编译器警告修复 (`get_eular2`)

- **问题:** Keil 编译时出现 C99 警告 "invalid in C99" for `get_eular2`。
- **原因:** 调用 `get_eular2` 的 `TASK/chasis_task.c` 文件未能找到该函数的声明（原型）。
- **修复:** 在 `HARDWARE/usart2.h` 文件中添加了 `extern int get_eular2(float* e);` 声明。
- **验证:** 确认 `get_eular2` 函数的定义存在于 `USER/usart2.c` 文件中。同时注意到 `usart2.h` 中存在 `get_eular` 的声明，但其定义在项目中缺失。

### 4. 文档更新 (`与上位机通讯问题.md`)

- 根据通信协议的修改，对文档进行了多次更新：
    - **初始:** 更新为描述简化的 69 字节命令帧。
    - **最终:** **恢复为描述原始的 81 字节命令帧**，以匹配最终的代码状态。
    - **发送频率:** 根据 `TASK/chasis_task.c` 中 `OSTimeDly` 的修改（从 8ms -> 10ms），将文档中所有相关的发送频率描述从 125Hz 更新为 **100Hz**。
    - **细节修正:** 修正了命令帧结构表格中因笔误导致的索引和大小偏差。
- **当前状态:** 文档现在准确描述了下位机发送 116 字节状态帧 (100Hz) 和接收 81 字节命令帧的协议。

## 后续通讯与维护注意点

1.  **上位机兼容性:** 当前下位机 UART3 接收逻辑已恢复到处理原始 81 字节命令帧，以确保与现有上位机代码兼容。未来若要修改下位机接收协议，必须同步修改上位机发送逻辑。
2.  **夹爪数据处理:** 虽然下位机 `USART3_IRQHandler` 现在会解析 81 字节帧中的夹爪电机数据并存入全局变量 (`gripper_*_control`)，但实际控制任务 (`Chasis_task`, `Gimbal_task` 等) 可能并未配置为使用这些通过 UART3 更新的值来驱动物理夹爪电机。如果未来需要恢复或修改夹爪功能，需要检查并确保控制任务正确使用了这些变量。
3.  **状态发送频率:** 下位机通过 `Chasis_task` 向上位机发送 116 字节状态数据的频率当前为 **100Hz**，由 `OSTimeDly(10, ...)` 控制。
4.  **任务使能宏:** `task.h` 文件中的 `EN_..._TASK` 宏（如 `EN_CHASIS_TASK`）控制着对应任务是否被编译和执行。在调试任务未运行的问题时，应首先检查这些宏的定义。
5.  **函数声明与定义:** 必须确保所有使用的函数在被调用前都有对应的声明（通常在 `.h` 文件中），并且有且仅有一个定义（在某个 `.c` 文件中），以避免编译警告和链接错误。注意 `usart2.h` 中可能存在未使用的 `get_eular` 函数声明。
6.  **文档同步:** `与上位机通讯问题.md` 是理解通讯协议的关键。未来对通讯协议（包括帧结构、频率、数据内容等）的任何修改，都必须同步更新此文档。

## IMU读数解析修改 - 2024年

### 背景概述

本次修改主要针对HI226款式IMU的数据获取和解析进行了更新。修改涉及四个串口（USART6、USART2、UART7、UART8）对应的四个IMU设备。根据IMU厂家提供的新版解析代码文件hipnuc_dec.c，对原有解析方法进行了替换，并添加了DMA支持以提高数据接收效率。

### 修改内容

#### 1. 核心技术变更

- **数据解析方法转换**
  - 从使用packet.c解析数据改为使用hipnuc_dec.c解析数据
  - 基于厂家提供的新版解析库，提取欧拉角数据

- **数据传输模式优化**
  - 添加DMA接收模式，替代原有的中断接收方式
  - 使用DMA循环模式，提高数据传输效率
  - 使用空闲中断（IDLE）代替接收中断（RXNE）处理数据

- **代码结构调整**
  - 简化各串口文件结构，保持一致的接口
  - 统一欧拉角获取函数命名（get_eular6/2/7/8）
  - 移除冗余功能，仅保留欧拉角数据的提取和访问

#### 2. 各文件具体修改

##### 2.1 usart69050.c修改

- **新增内容**
  - 添加DMA接收缓冲区（USART6_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu6_raw）
  - 定义欧拉角数据数组（eular6[3]）
  - 实现get_eular6()函数获取欧拉角数据

- **修改内容**
  - 修改USART6_init()函数，添加DMA配置
  - 修改USART6_IRQHandler()函数，使用空闲中断处理接收数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除原有packet.c相关解析代码
  - 移除不必要的数据处理函数（get_raw_acc, get_raw_gyo等）
  - 移除OnDataReceived回调函数

##### 2.2 usart2.c修改

- **新增内容**
  - 添加DMA接收缓冲区（USART2_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu2_raw）
  - 定义欧拉角数据数组（eular2[3]）
  - 实现get_eular2()函数获取欧拉角数据

- **修改内容**
  - 修改USART2_init()函数，添加DMA1_Stream5配置
  - 重构USART2_IRQHandler()函数，处理DMA接收的数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除imu_manager.h的引用
  - 移除旧的packet.c相关解析代码
  - 移除全局变量g_imu_rx_pkt等相关引用

##### 2.3 usart7.c修改

- **新增内容**
  - 添加DMA接收缓冲区（UART7_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu7_raw）
  - 定义欧拉角数据数组（eular7[3]）
  - 实现get_eular7()函数获取欧拉角数据

- **修改内容**
  - 修改UART7_init()函数，添加DMA1_Stream3配置
  - 修改UART7_IRQHandler()函数，使用空闲中断处理DMA接收的数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除imu_manager.h的引用
  - 移除旧的packet.c相关解析代码
  - 移除全局变量g_imu_rx_pkt等相关引用

##### 2.4 usart8.c修改

- **新增内容**
  - 添加DMA接收缓冲区（UART8_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu8_raw）
  - 定义欧拉角数据数组（eular8[3]）
  - 实现get_eular8()函数获取欧拉角数据

- **修改内容**
  - 修改UART8_init()函数，添加DMA1_Stream6配置
  - 修改UART8_IRQHandler()函数，处理DMA接收的数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除imu_manager.h的引用
  - 移除旧的packet.c相关解析代码
  - 移除全局变量g_imu_rx_pkt等相关引用

### 错误修复

- 修复编译错误：移除usart7.c和usart8.c中对不存在的"imu_manager.h"的引用

### 技术细节

#### DMA配置

| 串口 | DMA通道 | DMA流 |
|------|---------|-------|
| USART6 | DMA2 | Stream1, Channel 5 |
| USART2 | DMA1 | Stream5, Channel 4 |
| UART7 | DMA1 | Stream3, Channel 5 |
| UART8 | DMA1 | Stream6, Channel 5 |

#### 中断优先级

| 串口 | 抢占优先级 | 子优先级 |
|------|------------|----------|
| USART6 | 0 | 0 |
| USART2 | 0 | 0 |
| UART7 | 3 | 0 |
| UART8 | 3 | 0 |

### 后续建议

1. **函数接口统一**
   - 考虑统一get_eular系列函数的命名风格，或提供统一的接口

2. **错误处理增强**
   - 添加更完善的错误检测和异常处理机制
   - 考虑添加数据有效性验证

3. **性能优化**
   - 监控DMA传输效率
   - 优化中断处理逻辑减少处理延迟

4. **调试方案**
   - 在关键位置添加调试输出
   - 考虑添加数据统计功能（如接收帧率、错误率等）

## 上位机数据发送与集成 - [请在此处填写日期]

### 背景概述

在成功实现通过DMA方式从四个IMU（USART6, USART2, UART7, UART8）高效读取欧拉角数据后，本次更新重点在于将这些数据整合并发送至上位机，以供进一步处理和监控。

### 修改内容

#### 1. 数据整合与发送

- **数据获取**:
  - 在主循环或定时任务中，调用先前实现的 `get_eular6()`, `get_eular2()`, `get_eular7()`, `get_eular8()` 函数，获取四个IMU的实时欧拉角数据。

- **发送机制**:
  - 新增或修改了用于向上位机发送数据的函数或任务。
  - 设计并实现了数据打包逻辑，将四个IMU的欧拉角数据或其他必要信息组合成特定的数据帧格式。
  - 通过指定的通信接口（例如：USB VCP, 另一个串口, CAN等）将打包好的数据帧发送给上位机。

#### 2. 相关代码变更

- **变量引用**:
  - 发送任务或函数中引用了存储各IMU欧拉角数据的全局变量（如 `eular6`, `eular2`, `eular7`, `eular8`）。
- **函数调用**:
  - 调用了 `get_eularX()` 系列函数来确保获取的是最新的IMU数据。
  - 调用了底层通信接口的发送函数（如 HAL库的 `HAL_UART_Transmit`, `CDC_Transmit_FS` 等）来执行数据发送。
- **新增代码**:
  - 可能新增了数据帧的结构体定义。
  - 新增了负责打包和发送数据的主要逻辑函数/任务。

### 后续建议

- 确认上位机通信协议的稳定性和可靠性。
- 考虑添加数据校验机制（如CRC校验）以确保传输数据的完整性。
- 监控数据发送频率和实时性是否满足系统需求。
