# 项目修改日志

## IMU读数解析修改 - 2024年

### 背景概述

本次修改主要针对HI226款式IMU的数据获取和解析进行了更新。修改涉及四个串口（USART6、USART2、UART7、UART8）对应的四个IMU设备。根据IMU厂家提供的新版解析代码文件hipnuc_dec.c，对原有解析方法进行了替换，并添加了DMA支持以提高数据接收效率。

### 修改内容

#### 1. 核心技术变更

- **数据解析方法转换**
  - 从使用packet.c解析数据改为使用hipnuc_dec.c解析数据
  - 基于厂家提供的新版解析库，提取欧拉角数据

- **数据传输模式优化**
  - 添加DMA接收模式，替代原有的中断接收方式
  - 使用DMA循环模式，提高数据传输效率
  - 使用空闲中断（IDLE）代替接收中断（RXNE）处理数据

- **代码结构调整**
  - 简化各串口文件结构，保持一致的接口
  - 统一欧拉角获取函数命名（get_eular6/2/7/8）
  - 移除冗余功能，仅保留欧拉角数据的提取和访问

#### 2. 各文件具体修改

##### 2.1 usart69050.c修改

- **新增内容**
  - 添加DMA接收缓冲区（USART6_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu6_raw）
  - 定义欧拉角数据数组（eular6[3]）
  - 实现get_eular6()函数获取欧拉角数据

- **修改内容**
  - 修改USART6_init()函数，添加DMA配置
  - 修改USART6_IRQHandler()函数，使用空闲中断处理接收数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除原有packet.c相关解析代码
  - 移除不必要的数据处理函数（get_raw_acc, get_raw_gyo等）
  - 移除OnDataReceived回调函数

##### 2.2 usart2.c修改

- **新增内容**
  - 添加DMA接收缓冲区（USART2_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu2_raw）
  - 定义欧拉角数据数组（eular2[3]）
  - 实现get_eular2()函数获取欧拉角数据

- **修改内容**
  - 修改USART2_init()函数，添加DMA1_Stream5配置
  - 重构USART2_IRQHandler()函数，处理DMA接收的数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除imu_manager.h的引用
  - 移除旧的packet.c相关解析代码
  - 移除全局变量g_imu_rx_pkt等相关引用

##### 2.3 usart7.c修改

- **新增内容**
  - 添加DMA接收缓冲区（UART7_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu7_raw）
  - 定义欧拉角数据数组（eular7[3]）
  - 实现get_eular7()函数获取欧拉角数据

- **修改内容**
  - 修改UART7_init()函数，添加DMA1_Stream3配置
  - 修改UART7_IRQHandler()函数，使用空闲中断处理DMA接收的数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除imu_manager.h的引用
  - 移除旧的packet.c相关解析代码
  - 移除全局变量g_imu_rx_pkt等相关引用

##### 2.4 usart8.c修改

- **新增内容**
  - 添加DMA接收缓冲区（UART8_RX_BUF_SIZE）
  - 添加hipnuc_raw_t结构体实例（imu8_raw）
  - 定义欧拉角数据数组（eular8[3]）
  - 实现get_eular8()函数获取欧拉角数据

- **修改内容**
  - 修改UART8_init()函数，添加DMA1_Stream6配置
  - 修改UART8_IRQHandler()函数，处理DMA接收的数据
  - 使用hipnuc_input()函数解析数据

- **移除内容**
  - 移除imu_manager.h的引用
  - 移除旧的packet.c相关解析代码
  - 移除全局变量g_imu_rx_pkt等相关引用

### 错误修复

- 修复编译错误：移除usart7.c和usart8.c中对不存在的"imu_manager.h"的引用

### 技术细节

#### DMA配置

| 串口 | DMA通道 | DMA流 |
|------|---------|-------|
| USART6 | DMA2 | Stream1, Channel 5 |
| USART2 | DMA1 | Stream5, Channel 4 |
| UART7 | DMA1 | Stream3, Channel 5 |
| UART8 | DMA1 | Stream6, Channel 5 |

#### 中断优先级

| 串口 | 抢占优先级 | 子优先级 |
|------|------------|----------|
| USART6 | 0 | 0 |
| USART2 | 0 | 0 |
| UART7 | 3 | 0 |
| UART8 | 3 | 0 |

### 后续建议

1. **函数接口统一**
   - 考虑统一get_eular系列函数的命名风格，或提供统一的接口

2. **错误处理增强**
   - 添加更完善的错误检测和异常处理机制
   - 考虑添加数据有效性验证

3. **性能优化**
   - 监控DMA传输效率
   - 优化中断处理逻辑减少处理延迟

4. **调试方案**
   - 在关键位置添加调试输出
   - 考虑添加数据统计功能（如接收帧率、错误率等）

## 上位机数据发送与集成 - [请在此处填写日期]

### 背景概述

在成功实现通过DMA方式从四个IMU（USART6, USART2, UART7, UART8）高效读取欧拉角数据后，本次更新重点在于将这些数据整合并发送至上位机，以供进一步处理和监控。

### 修改内容

#### 1. 数据整合与发送

- **数据获取**:
  - 在主循环或定时任务中，调用先前实现的 `get_eular6()`, `get_eular2()`, `get_eular7()`, `get_eular8()` 函数，获取四个IMU的实时欧拉角数据。

- **发送机制**:
  - 新增或修改了用于向上位机发送数据的函数或任务。
  - 设计并实现了数据打包逻辑，将四个IMU的欧拉角数据或其他必要信息组合成特定的数据帧格式。
  - 通过指定的通信接口（例如：USB VCP, 另一个串口, CAN等）将打包好的数据帧发送给上位机。

#### 2. 相关代码变更

- **变量引用**:
  - 发送任务或函数中引用了存储各IMU欧拉角数据的全局变量（如 `eular6`, `eular2`, `eular7`, `eular8`）。
- **函数调用**:
  - 调用了 `get_eularX()` 系列函数来确保获取的是最新的IMU数据。
  - 调用了底层通信接口的发送函数（如 HAL库的 `HAL_UART_Transmit`, `CDC_Transmit_FS` 等）来执行数据发送。
- **新增代码**:
  - 可能新增了数据帧的结构体定义。
  - 新增了负责打包和发送数据的主要逻辑函数/任务。

### 后续建议

- 确认上位机通信协议的稳定性和可靠性。
- 考虑添加数据校验机制（如CRC校验）以确保传输数据的完整性。
- 监控数据发送频率和实时性是否满足系统需求。
