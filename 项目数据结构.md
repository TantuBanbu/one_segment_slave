# 项目数据结构

## 整体数据流架构

本项目是一个基于STM32F4系列微控制器的蛇形机器人系统，主要包括以下数据流：

1. **上位机 (ROS2) → 下位机 (STM32)**：通过UART3实现通信，上位机发送控制命令
2. **下位机 → 电机**：通过CAN1总线发送控制指令给各电机
3. **电机 → 下位机**：通过CAN1总线反馈状态信息
4. **下位机 → 上位机**：通过UART3将电机状态、IMU数据等反馈给上位机

## 上位机到下位机的数据流 (ROS2 → STM32)

### 通信协议

1. **通信接口**：UART3 (115200 bps)
2. **数据帧格式**：
   - 帧头：0xAA 0x55 (固定标志)
   - 地址：0x01 (控制器地址)
   - 长度：0x4B (固定帧长度)
   - 功能码：0x31 (电机控制命令)
   - 数据段：根据功能码不同而变化
   - CRC校验：使用Modbus CRC-16校验算法

### 控制命令数据结构 (UART3接收)

控制命令包含以下关键数据：

1. **蛇形机器人关节电机**：
   - 12个关节电机的位置和速度控制值
   - 数据格式：每个电机对应一个速度值(4字节)和一个位置值(4字节)

2. **机械臂控制**：
   - `gripper_gm6020_position_control`：GM6020电机位置控制(2字节)
   - `gripper_c610_position_control`：C610电机位置控制(2字节)
   - `gripper_sts3032_position_control`：STS3032舵机位置控制(2字节)

3. **系统控制**：
   - `reset_control`：复位控制标志(1字节)
     - 值为1：复位所有电机
     - 值为6：禁用所有电机
     - 值为9：启用所有电机

### 数据解析流程

1. 在`USART3_IRQHandler`函数中接收数据
2. 根据帧头(0xAA 0x55)识别有效数据包
3. 接收完整数据包后进行CRC校验
4. 校验成功后解析数据包中的控制值
5. 将解析出的控制值存储到全局变量中，供其他模块使用

## 下位机到电机的数据流 (STM32 → 电机)

### 电机类型与通信方式

本系统使用三种类型的电机：

1. **蛇形机器人关节电机**：通过CAN1总线控制
2. **GM6020电机**：通过CAN1总线控制，主要用于机械臂
3. **C610电机**：通过CAN1总线控制，主要用于机械臂
4. **STS3032舵机**：使用其他方式控制

### CAN总线通信

通过定义专用函数向各类电机发送控制命令：

1. 蛇形机器人关节电机控制函数：
   - `motorEnable`: 使能/禁用电机
   - `setMotorTargetPosition`: 设置目标位置
   - `setMotorTargetSpeed`: 设置目标速度
   - `setMotorTargetCurrent`: 设置目标电流
   - `setMotorTargetAcspeed`: 设置加速度
   - `setMotorTargetDespeed`: 设置减速度

2. 机械臂电机控制函数：
   - `GM6020_Can_Send_Msg`: 控制GM6020电机
   - `C610_Can_Send_Msg`: 控制C610电机

## 电机到下位机的数据流 (电机 → STM32)

### 数据接收与处理

电机状态通过CAN1总线反馈给STM32，在`CAN1_RX0_IRQHandler`函数中处理接收到的数据。

1. **蛇形机器人关节电机**：
   - 通过电机ID (0x01-0x0C) 区分不同的电机
   - 接收关节电机的当前位置 (`currentPosition_snake[12]`)
   - 接收关节电机的当前速度 (`currentSpeed_snake[12]`)

2. **机械臂电机**：
   - 接收GM6020电机的位置、速度、电流和温度信息 (`GripperMotor_205_t`)
   - 接收C610电机的位置、速度、电流和温度信息 (`GripperMotor_201_t`)
   - 跟踪电机的绝对位置，处理多圈旋转 (`GM6020_absolute_position`, `C610_absolute_position`)

### 位置计算与漂移补偿

1. 关节电机位置计算：`currentPosition_snake[i] = 原始位置 - offsetPosition_snake[i]`
2. 电机复位时更新位置偏移量：`offsetPosition_snake[i] = currentPosition_snake[i] + offsetPosition_snake[i]`

## 下位机到上位机的数据流 (STM32 → ROS2)

通过UART3将电机状态数据和IMU数据传送回上位机。上位机通过解析这些数据来监控机器人状态并进行闭环控制。

### 数据发送函数

`TX2_Transmit_Start` 函数用于通过UART3向上位机发送数据。

## 软件架构与任务分配

系统基于uC/OS-III实时操作系统，通过多任务方式管理各个模块：

1. **Start_task**: 系统初始化和任务创建
2. **Init_task**: 硬件初始化，包括GPIO、CAN、UART等
3. **Chasis_task**: 控制底盘运动
4. **Gimbal_task**: 控制云台
5. **Gun_task**: 控制发射机构
6. **Time_task**: 时间相关操作

## 关键数据结构

1. **蛇形机器人相关**：
   - `snake_motor_position_control[12]`: 12个关节电机的位置控制值
   - `snake_motor_speed_control[12]`: 12个关节电机的速度控制值
   - `currentPosition_snake[12]`: 12个关节电机的当前位置
   - `currentSpeed_snake[12]`: 12个关节电机的当前速度
   - `offsetPosition_snake[12]`: 12个关节电机的位置偏移量

2. **机械臂相关**：
   - `gripper_gm6020_position_control`: GM6020电机位置控制
   - `gripper_c610_position_control`: C610电机位置控制
   - `gripper_sts3032_position_control`: STS3032舵机位置控制
   - `GripperMotor_205_t`: GM6020电机状态
   - `GripperMotor_201_t`: C610电机状态

## IMU数据流

与IMU数据相关的部分也被更新为使用基于DMA的高效数据接收方式和新的hipnuc_dec.c解析库，数据通过四个不同的串口(USART6、USART2、UART7、UART8)并行接收并解析。

1. 各IMU数据结构：
   - `eular6[3]`, `eular2[3]`, `eular7[3]`, `eular8[3]`: 保存各IMU的欧拉角数据(pitch, roll, yaw)
   - `imu6_raw`, `imu2_raw`, `imu7_raw`, `imu8_raw`: 保存各IMU的原始数据

2. IMU数据获取接口：
   - `get_eular6()`, `get_eular2()`, `get_eular7()`, `get_eular8()`: 用于获取各IMU的欧拉角数据
